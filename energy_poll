#!/usr/bin/bash

TMP_NAME="${ENERGY_POLL:-energy_poll}"
CACHE_DIR="/tmp/${TMP_NAME}"
ENERGY_BEFORE_FILE="${CACHE_DIR}/energy_before"
BATTERY_LEFT_FILE="${CACHE_DIR}/battery_left"

BATTERY_PATH="/sys/class/power_supply/BAT0"
ENERGY_NOW_FILE="${BATTERY_PATH}/energy_now"

INTERVAL_SECONDS=120

write_atomic() {
    local file="$1" content="$2"
    local tmp
    tmp=$(mktemp -p "$CACHE_DIR") && echo "$content" > "$tmp" && mv -- "$tmp" "$file"
}

mkdir -p "$CACHE_DIR"

while true; do
    mkdir -p "$CACHE_DIR"

    if [ ! -f "$ENERGY_NOW_FILE" ]; then
        echo "No energy_now at ${BATTERY_PATH}" >&2
        sleep "$INTERVAL_SECONDS"
        continue;
    fi

    energy_now=$(cat "$ENERGY_NOW_FILE" 2>/dev/null)
    if [ -z "$energy_now" ] || [ "$energy_now" -le 0 ] 2>/dev/null; then
        sleep "$INTERVAL_SECONDS"
        continue
    fi
    
    if [ ! -f "$ENERGY_BEFORE_FILE" ]; then
        write_atomic "$ENERGY_BEFORE_FILE" "$energy_now"
        sleep "$INTERVAL_SECONDS"
        continue;
    fi

    energy_before=$(cat "$ENERGY_BEFORE_FILE" 2>/dev/null)
    write_atomic "$ENERGY_BEFORE_FILE" "$energy_now"

    energy_used=$((energy_before - energy_now))
    if [ "$energy_used" -le 0 ] 2>/dev/null; then
        write_atomic "$BATTERY_LEFT_FILE" "♾️"
        sleep "$INTERVAL_SECONDS"
        continue
    fi

    minutes_left=$((energy_now * 2 / energy_used))
    if [ "$minutes_left" -gt 12 * 60 ] 2>/dev/null; then
        write_atomic "$BATTERY_LEFT_FILE" "♾️"
        sleep "$INTERVAL_SECONDS"
        continue
    fi

    write_atomic "$BATTERY_LEFT_FILE" "$minutes_left"
    sleep "$INTERVAL_SECONDS"
done
