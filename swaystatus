#!/usr/bin/sh

CACHE_DIR="${SWAYSTATUS_DIR:-/tmp/swaystatus/}"
CACHE_FILE="${CACHE_DIR}swaystatus_airquality"
LOW_BATTERY_STATE="${CACHE_DIR}low_battery_notified"
NOTIFICATION_SENT_FILE="${CACHE_DIR}notification_sent"

SUSPEND_SCRIPT="$HOME/.local/bin/suspend_to_ram"

mkdir -p "$CACHE_DIR"
[ ! -f "$CACHE_FILE" ] && touch "$CACHE_FILE"
[ ! -f "$LOW_BATTERY_STATE" ] && touch "$LOW_BATTERY_STATE"
[ ! -f "$NOTIFICATION_SENT_FILE" ] && touch "$NOTIFICATION_SENT_FILE"

if ! pgrep -f "swaystatus_aqi.py" > /dev/null; then
    $HOME/.local/bin/swaystatus_aqi.py &
fi

function get_formatted_air_quality() {
    if [ -f "${CACHE_FILE}_formatted" ]; then
        cat "${CACHE_FILE}_formatted"
    else
        echo "N/A: PM2.5âšª-1 | NO2âšª-1 | COâšª-1 | ğŸŒ¡ï¸-273Â°C | ğŸ’§-1% | ğŸ“¥-1hPa | ğŸ’¨36000m/s"
    fi
}

function low_battery_notification() {
	battery_level=$1
	time_left_minutes=$2
	
	time_left_minutes=${time_left_minutes:-999}
	
	if [ "$battery_level" -lt 11 ] || [ "$time_left_minutes" -lt 13 ]; then
		urgency="critical"

	elif [ "$battery_level" -gt 20 ] && [ "$time_left_minutes" -gt 25 ]; then
		urgency="low"

	else
		urgency="normal"
	fi
	notify-send -u "$urgency" "Battery low: ${battery_level}%!"
}

function get_battery_info()
{
	battery="/sys/class/power_supply/BAT0/"
	[[ ! -d "$battery" ]] && echo -n "?" && return 1;

	info=''
	
	now=$(($(<"$battery/energy_now") * 100 / $(<"$battery/energy_full")))
	degradation=$((100 - $(<"$battery/energy_full") * 100 / $(<"$battery/energy_full_design")))

	if [ "$degradation" -le 10 ]; then
		deg_icon="ğŸ‘¶"
	elif [ "$degradation" -le 20 ]; then
		deg_icon="ğŸ§’"
	elif [ "$degradation" -le 30 ]; then
		deg_icon="ğŸ§‘"
	elif [ "$degradation" -le 40 ]; then
		deg_icon="ğŸ§”"
	elif [ "$degradation" -le 50 ]; then
		deg_icon="ğŸ§“"
	elif [ "$degradation" -le 60 ]; then
		deg_icon="ğŸ‘´"
	elif [ "$degradation" -le 70 ]; then
		deg_icon="ğŸ’€"
	elif [ "$degradation" -le 80 ]; then
		deg_icon="ğŸ§Ÿ"
	elif [ "$degradation" -le 90 ]; then
		deg_icon="ğŸ‘»"
	else
		deg_icon="ğŸ«¥"
	fi

	if [ ! -f "$battery/status" ]; then
		state="â“"
	else
		state=$(cat "$battery/status")
	fi
	case "$state" in
		Full)
		state="ğŸ”‹"
		;;

		Discharging|"Not charging")
		state="â™»ï¸"
		;;

		Charging)
		state="âš¡"
		;;

		Unknown)
		state="â“"
		;;
	esac

	uptime=$(stat -c %Y "$LOW_BATTERY_STATE" 2>/dev/null)
	uptime_now=$(date +%s)
	uptime_diff=$((uptime_now - uptime))

	if [ ! -f "$LOW_BATTERY_STATE" ]; then
		touch "$LOW_BATTERY_STATE"
	fi

	time_left=""
	total_minutes=""
	if [ -f "/tmp/energy_poll/battery_left" ]; then
		total_minutes=$(cat /tmp/energy_poll/battery_left)
		total_minutes=${total_minutes%.*}
		if [ -n "$total_minutes" ] && [ "$total_minutes" -gt 0 ] 2>/dev/null; then
			hours=$((total_minutes / 60))
			minutes=$((total_minutes % 60))
			
			if [ "$total_minutes" -lt 13 ]; then
				indicator="â—ï¸"
			elif [ "$total_minutes" -lt 25 ]; then
				indicator="ğŸ”´"
			elif [ "$total_minutes" -gt 45 ]; then
				indicator="ğŸŸ¡" 
			else 
				indicator="ğŸŸ¢"
			fi
			
			if [ "$hours" -gt 0 ]; then
				time_left=" ${indicator}${hours}h${minutes}m"
			else
				time_left=" ${indicator}${minutes}m"
			fi
		fi
	fi

	if [ "$state" != "âš¡" ] &&  [ "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" = "1" ]; then
		notification_sent=$(cat "$NOTIFICATION_SENT_FILE" 2>/dev/null || echo "0")
		if ( [ -n "$uptime" ] && [ "$uptime_diff" -gt 120 ] ) || [ "$notification_sent" -eq 0 ]; then
			low_battery_notification "$now" "${total_minutes:-999}"
			echo "1" > "$NOTIFICATION_SENT_FILE"
			touch "$LOW_BATTERY_STATE"
		fi
	fi

	if [ "$now" -lt 15 ] || [ "${total_minutes:-999}" -lt 22 ]; then
		if [ -z "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" ] || [ "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" = "0" ]; then
			echo 1 > "$LOW_BATTERY_STATE" 2>/dev/null

			if [ -x "$SUSPEND_SCRIPT" ] && [ "$SWAYSTATUS_ENABLE_SUSPEND_TO_RAM" = "TRUE" ]; then
				if [ "$now" -lt 6 ] || [ "${total_minutes:-999}" -lt 8 ]; then
					SWAYSTATUS_ENABLE_SUSPEND_TO_RAM=TRUE "$SUSPEND_SCRIPT" &
				fi
			fi

		fi
	else
		if [ -z "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" ] || [ "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" = "1" ]; then
			echo 0 > "$LOW_BATTERY_STATE" 2>/dev/null
		fi
	fi

	echo -n "$state$now%$time_left ğŸª¦$degradation%$deg_icon"
}

function update_status() {
	aqi_line=$(get_formatted_air_quality)

	if [ -f "/tmp/sound_changed_event" ]; then
		volume_line=$(</tmp/sound_changed_event)
	else
		volume_line=""
	fi
	
	if [ "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" != "1" ]; then
		echo "0" > "$NOTIFICATION_SENT_FILE" 2>/dev/null
	fi
	
	battery_level=$(get_battery_info)
	date=$(date "+%d %b %Y %H:%M")
	echo "$aqi_line | $battery_level | $volume_line | $date"
}

# Call immediately - output will be flushed automatically
update_status

$HOME/.local/bin/upvolstatus
touch /tmp/power_changed_event

while :
do
	sleep 30
	update_status
done