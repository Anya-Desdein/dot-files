#!/usr/bin/sh
CACHE_DIR_DEFAULT="/tmp/swaystatus/"
CACHE_FILE_DEFAULT="${CACHE_DIR_DEFAULT}swaystatus_airquality"
CACHE_FILE="${SWAYSTATUS_DATA_FILE:-$CACHE_FILE_DEFAULT}"
LOW_BATTERY_STATE="${CACHE_DIR_DEFAULT}low_battery_notified"
SUSPEND_SCRIPT="$HOME/.local/bin/suspend_to_ram"

mkdir -p "$CACHE_DIR_DEFAULT"

# Ensure file exists for inotifywait, but don't overwrite if it has content
if [ ! -f "$CACHE_FILE" ]; then
    touch "$CACHE_FILE"
fi

if ! pgrep -f "swaystatus_aqi.py" > /dev/null; then
    $HOME/.local/bin/swaystatus_aqi.py &
fi

function get_formatted_air_quality() {
    if [ -f "${CACHE_FILE}_formatted" ]; then
        cat "${CACHE_FILE}_formatted"
    else
        echo "N/A: PM2.5âšª-1 | NO2âšª-1 | COâšª-1 | ğŸŒ¡ï¸-273Â°C | ğŸ’§-1% | ğŸ“¥-1hPa | ğŸ’¨36000m/s"
    fi
}

function low_battery_notification() {
	notify-send -u critical "Battery low: ${now}%!"
}

function get_battery_info()
{
	battery="/sys/class/power_supply/BAT0/"
	[[ ! -d "$battery" ]] && echo -n "No battery?" && exit;

	info=''
	
	now=$(expr $(<"$battery/energy_now") \* 100 / $(<"$battery/energy_full"))
	degradation=$(expr 100 - $(<"$battery/energy_full") \* 100 / $(<"$battery/energy_full_design"))

	if [ "$degradation" -le 10 ]; then
		deg_icon="ğŸ‘¶"
	elif [ "$degradation" -le 20 ]; then
		deg_icon="ğŸ§’"
	elif [ "$degradation" -le 30 ]; then
		deg_icon="ğŸ§‘"
	elif [ "$degradation" -le 40 ]; then
		deg_icon="ğŸ§”"
	elif [ "$degradation" -le 50 ]; then
		deg_icon="ğŸ§“"
	elif [ "$degradation" -le 60 ]; then
		deg_icon="ğŸ‘´"
	elif [ "$degradation" -le 70 ]; then
		deg_icon="ğŸ§‘"
	elif [ "$degradation" -le 80 ]; then
		deg_icon="ğŸ’€"
	elif [ "$degradation" -le 90 ]; then
		deg_icon="ğŸ§Ÿ"
	else
		deg_icon="ğŸ‘»"
	fi

	state=$(cat "$battery/status")
	case "$state" in
		Full)
		state="ğŸ”‹"
		;;

		Discharging|"Not charging")
		state="â™»ï¸"
		;;

		Charging)
		state="âš¡"
		;;

		Unknown)
		state="â“"
		;;
	esac

	uptime=$(stat -c %Y "$LOW_BATTERY_STATE" 2>/dev/null)
	uptime_now=$(date +%s)
	uptime_diff=$((uptime_now - uptime))

	if [ ! -f "$LOW_BATTERY_STATE" ]; then
		touch "$LOW_BATTERY_STATE"
	fi

	if [ "$state" != "âš¡" ] &&  [ "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" = "1" ]; then
		if [ -n "$uptime" ] && [ "$uptime_diff" -gt 120 ]; then
			low_battery_notification
			touch "$LOW_BATTERY_STATE"
		fi
	fi

	time_left=""
	if [ -f "/tmp/energy_poll/battery_left" ]; then
		total_minutes=$(cat /tmp/energy_poll/battery_left)
		total_minutes=${total_minutes%.*}
		if [ -n "$total_minutes" ] && [ "$total_minutes" -gt 0 ] 2>/dev/null; then
			hours=$((total_minutes / 60))
			minutes=$((total_minutes % 60))
			
			if [ "$total_minutes" -lt 13 ]; then
				indicator="â—ï¸"
			elif [ "$total_minutes" -lt 25 ]; then
				indicator="ğŸ”´"
			elif [ "$total_minutes" -gt 45 ]; then
				indicator="ğŸŸ¡" 
			else 
				indicator="ğŸŸ¢"
			fi
			
			if [ "$hours" -gt 0 ]; then
				time_left=" ${indicator}${hours}h${minutes}m"
			else
				time_left=" ${indicator}${minutes}m"
			fi
		fi
	fi

	if [ "$now" -lt 11 ] || [ "${total_minutes:-999}" -lt 13 ]; then
		if [ -z "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" ] || [ "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" == "0" ]; then
			echo 1 > "$LOW_BATTERY_STATE" 2>/dev/null

			if [ -x "$SUSPEND_SCRIPT" ] && [ "$SWAYSTATUS_ENABLE_SUSPEND_TO_RAM" = "TRUE" ]; then
				if [ "$now" -lt 6 ] || [ "${total_minutes:-999}" -lt 8 ]; then
					SWAYSTATUS_ENABLE_SUSPEND_TO_RAM=TRUE "$SUSPEND_SCRIPT" &
				fi
			fi

		fi
	else
		if [ -z "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" ] || [ "$(cat "$LOW_BATTERY_STATE" 2>/dev/null)" == "1" ]; then
			echo 0 > "$LOW_BATTERY_STATE" 2>/dev/null
		fi
	fi

	echo -n "$state$now%$time_left ğŸª¦$degradation%$deg_icon"
}

# Start the fetcher daemon
# Kill existing instances to avoid duplicates

# Just to refresh the status bar at start
$HOME/.local/bin/upvolstatus
touch /tmp/power_changed_event

while :
do
	aqi_line=$(get_formatted_air_quality)
	volume_line=$(</tmp/sound_changed_event)
	battery_level=$(get_battery_info)
	date=$(date "+%d %b %Y %H:%M")
	echo "$aqi_line | $battery_level | $volume_line | $date"

	inotifywait -e modify -t 30 /tmp/power_changed_event /tmp/sound_changed_event -o /dev/null
done
