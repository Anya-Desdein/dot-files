#!/usr/bin/sh
CACHE_DIR_DEFAULT="/tmp/swaystatus/"
CACHE_FILE_DEFAULT="${CACHE_DIR_DEFAULT}swaystatus_airquality"
CACHE_FILE="${SWAYSTATUS_DATA_FILE:-$CACHE_FILE_DEFAULT}"

mkdir -p "$CACHE_DIR_DEFAULT"

# Ensure file exists for inotifywait, but don't overwrite if it has content
if [ ! -f "$CACHE_FILE" ]; then
    touch "$CACHE_FILE"
fi

if ! pgrep -f "swaystatus_aqi.py" > /dev/null; then
    $HOME/.local/bin/swaystatus_aqi.py &
fi

function get_formatted_air_quality() {
    if [ -f "${CACHE_FILE}_formatted" ]; then
        cat "${CACHE_FILE}_formatted"
    else
        echo "N/A: PM2.5âšª-1 | NO2âšª-1 | COâšª-1 | ğŸŒ¡ï¸-273.15Â°C | ğŸ’§-1% | ğŸ“¥-1hPa | ğŸ’¨36000m/s"
    fi
}

function get_battery_info()
{
	battery="/sys/class/power_supply/BAT0/"
	[[ ! -d "$battery" ]] && echo -n "No battery?" && exit;

	info=''
	now=$(expr $(<"$battery/energy_now") \* 100 / $(<"$battery/energy_full_design"))

	state=$(cat "$battery/status")
	case "$state" in
		Full)
		state="ğŸ”‹"
		;;

		Discharging)
		state="â™»ï¸"
		;;

		Charging|Unknown)
		state="âš¡"
		;;
	esac

	echo -n "$state$now%"
}

# Start the fetcher daemon
# Kill existing instances to avoid duplicates

# Just to refresh the status bar at start
$HOME/.local/bin/upvolstatus
touch /tmp/power_changed_event

while :
do
	aqi_line=$(get_formatted_air_quality)
	volume_line=$(</tmp/sound_changed_event)
	battery_level=$(get_battery_info)
	date=$(date "+%d %b %Y %H:%M")
	echo "$aqi_line | $battery_level | $volume_line | $date"

	inotifywait -e modify -t 30 /tmp/power_changed_event /tmp/sound_changed_event -o /dev/null
done
